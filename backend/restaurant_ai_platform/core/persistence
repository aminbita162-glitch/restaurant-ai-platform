# persistence package


import json
import os
import sqlite3
from datetime import datetime
from typing import Any, Dict, Optional


def _utc_ts() -> str:
    return datetime.utcnow().isoformat()


def _db_path() -> str:
    return os.getenv("PIPELINE_DB_PATH", "/tmp/restaurant_ai_pipeline.db")


def _get_conn() -> sqlite3.Connection:
    conn = sqlite3.connect(_db_path())
    conn.row_factory = sqlite3.Row
    return conn


def init_db() -> None:
    conn = _get_conn()
    cur = conn.cursor()
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS pipeline_runs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            stored_at TEXT NOT NULL,
            run_id TEXT,
            request_id TEXT,
            status TEXT,
            payload_json TEXT NOT NULL
        )
        """
    )
    cur.execute(
        "CREATE INDEX IF NOT EXISTS idx_pipeline_runs_stored_at ON pipeline_runs(stored_at)"
    )
    conn.commit()
    conn.close()


def save_run(payload: Dict[str, Any]) -> Dict[str, Any]:
    init_db()

    stored_at = _utc_ts()
    run_id = str(payload.get("run_id") or "")
    request_id = str(payload.get("request_id") or "")
    status = str(payload.get("status") or "")

    to_store = {**payload, "stored_at": stored_at}
    payload_json = json.dumps(to_store, ensure_ascii=False)

    conn = _get_conn()
    cur = conn.cursor()
    cur.execute(
        """
        INSERT INTO pipeline_runs (stored_at, run_id, request_id, status, payload_json)
        VALUES (?, ?, ?, ?, ?)
        """,
        (stored_at, run_id, request_id, status, payload_json),
    )
    conn.commit()
    conn.close()

    return to_store


def get_last_run() -> Optional[Dict[str, Any]]:
    init_db()

    conn = _get_conn()
    cur = conn.cursor()
    cur.execute(
        """
        SELECT payload_json
        FROM pipeline_runs
        ORDER BY id DESC
        LIMIT 1
        """
    )
    row = cur.fetchone()
    conn.close()

    if not row:
        return None

    try:
        return json.loads(row["payload_json"])
    except Exception:
        return None